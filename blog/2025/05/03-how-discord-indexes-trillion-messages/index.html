<!DOCTYPE html><html lang="en" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="BigJoe" href="https://www.joewalker.xzy/rss.xml"><meta name="generator" content="Astro v5.7.4"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://www.joewalker.xzy/blog/2025/05/03-how-discord-indexes-trillion-messages/"><!-- Primary Meta Tags --><title>Discord: Search หา message จากข้อมูลหลัก Trillion ยังไง?</title><meta name="title" content="Discord: Search หา message จากข้อมูลหลัก Trillion ยังไง?"><meta name="description" content="Discord: Search หา message จากข้อมูลหลัก Trillion ยังไง?"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://www.joewalker.xzy/blog/2025/05/03-how-discord-indexes-trillion-messages/"><meta property="og:title" content="Discord: Search หา message จากข้อมูลหลัก Trillion ยังไง?"><meta property="og:description" content="Discord: Search หา message จากข้อมูลหลัก Trillion ยังไง?"><meta property="og:image" content="https://www.joewalker.xzy/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://www.joewalker.xzy/blog/2025/05/03-how-discord-indexes-trillion-messages/"><meta property="twitter:title" content="Discord: Search หา message จากข้อมูลหลัก Trillion ยังไง?"><meta property="twitter:description" content="Discord: Search หา message จากข้อมูลหลัก Trillion ยังไง?"><meta property="twitter:image" content="https://www.joewalker.xzy/blog-placeholder-1.jpg"><!-- Google Analytic --><script src="https://www.googletagmanager.com/gtag/js?id=G-72RJB9H4WY"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-72RJB9H4WY');
</script><style>/*! tailwindcss v4.1.4 | MIT License | https://tailwindcss.com */@layer properties{@supports (((-webkit-hyphens:none)) and (not (margin-trim:inline))) or ((-moz-orient:inline) and (not (color:rgb(from red r g b)))){*,:before,:after,::backdrop{--tw-rotate-x:initial;--tw-rotate-y:initial;--tw-rotate-z:initial;--tw-skew-x:initial;--tw-skew-y:initial;--tw-space-y-reverse:0;--tw-border-style:solid;--tw-leading:initial;--tw-font-weight:initial;--tw-shadow:0 0 #0000;--tw-shadow-color:initial;--tw-shadow-alpha:100%;--tw-inset-shadow:0 0 #0000;--tw-inset-shadow-color:initial;--tw-inset-shadow-alpha:100%;--tw-ring-color:initial;--tw-ring-shadow:0 0 #0000;--tw-inset-ring-color:initial;--tw-inset-ring-shadow:0 0 #0000;--tw-ring-inset:initial;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-offset-shadow:0 0 #0000;--tw-outline-style:solid}}}@layer theme{:root,:host{--font-sans:ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--color-blue-600:oklch(54.6% .245 262.881);--color-gray-200:oklch(92.8% .006 264.531);--color-gray-600:oklch(44.6% .03 256.802);--color-gray-700:oklch(37.3% .034 259.733);--color-white:#fff;--spacing:.25rem;--container-xs:20rem;--container-sm:24rem;--text-lg:1.125rem;--text-lg--line-height:calc(1.75/1.125);--text-2xl:1.5rem;--text-2xl--line-height:calc(2/1.5);--font-weight-medium:500;--font-weight-bold:700;--leading-relaxed:1.625;--radius-md:.375rem;--default-transition-duration:.15s;--default-transition-timing-function:cubic-bezier(.4,0,.2,1);--default-font-family:var(--font-sans);--default-mono-font-family:var(--font-mono)}}@layer base{*,:after,:before,::backdrop{box-sizing:border-box;border:0 solid;margin:0;padding:0}::file-selector-button{box-sizing:border-box;border:0 solid;margin:0;padding:0}html,:host{-webkit-text-size-adjust:100%;tab-size:4;line-height:1.5;font-family:var(--default-font-family,ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji");font-feature-settings:var(--default-font-feature-settings,normal);font-variation-settings:var(--default-font-variation-settings,normal);-webkit-tap-highlight-color:transparent}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,samp,pre{font-family:var(--default-mono-font-family,ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace);font-feature-settings:var(--default-mono-font-feature-settings,normal);font-variation-settings:var(--default-mono-font-variation-settings,normal);font-size:1em}small{font-size:80%}sub,sup{vertical-align:baseline;font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}:-moz-focusring{outline:auto}progress{vertical-align:baseline}summary{display:list-item}ol,ul,menu{list-style:none}img,svg,video,canvas,audio,iframe,embed,object{vertical-align:middle;display:block}img,video{max-width:100%;height:auto}button,input,select,optgroup,textarea{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;opacity:1;background-color:#0000;border-radius:0}::file-selector-button{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;opacity:1;background-color:#0000;border-radius:0}:where(select:is([multiple],[size])) optgroup{font-weight:bolder}:where(select:is([multiple],[size])) optgroup option{padding-inline-start:20px}::file-selector-button{margin-inline-end:4px}::placeholder{opacity:1}@supports (not ((-webkit-appearance:-apple-pay-button))) or (contain-intrinsic-size:1px){::placeholder{color:currentColor}@supports (color:color-mix(in lab,red,red)){::placeholder{color:color-mix(in oklab,currentcolor 50%,transparent)}}}textarea{resize:vertical}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-date-and-time-value{min-height:1lh;text-align:inherit}::-webkit-datetime-edit{display:inline-flex}::-webkit-datetime-edit-fields-wrapper{padding:0}::-webkit-datetime-edit{padding-block:0}::-webkit-datetime-edit-year-field{padding-block:0}::-webkit-datetime-edit-month-field{padding-block:0}::-webkit-datetime-edit-day-field{padding-block:0}::-webkit-datetime-edit-hour-field{padding-block:0}::-webkit-datetime-edit-minute-field{padding-block:0}::-webkit-datetime-edit-second-field{padding-block:0}::-webkit-datetime-edit-millisecond-field{padding-block:0}::-webkit-datetime-edit-meridiem-field{padding-block:0}:-moz-ui-invalid{box-shadow:none}button,input:where([type=button],[type=reset],[type=submit]){appearance:button}::file-selector-button{appearance:button}::-webkit-inner-spin-button{height:auto}::-webkit-outer-spin-button{height:auto}[hidden]:where(:not([hidden=until-found])){display:none!important}}@layer components;@layer utilities{.invisible{visibility:hidden}.absolute{position:absolute}.fixed{position:fixed}.relative{position:relative}.static{position:static}.inset-0{inset:calc(var(--spacing)*0)}.isolate{isolation:isolate}.container{width:100%}@media (min-width:40rem){.container{max-width:40rem}}@media (min-width:48rem){.container{max-width:48rem}}@media (min-width:64rem){.container{max-width:64rem}}@media (min-width:80rem){.container{max-width:80rem}}@media (min-width:96rem){.container{max-width:96rem}}.m-2{margin:calc(var(--spacing)*2)}.m-26{margin:calc(var(--spacing)*26)}.m-30{margin:calc(var(--spacing)*30)}.m-42{margin:calc(var(--spacing)*42)}.m-50{margin:calc(var(--spacing)*50)}.m-51{margin:calc(var(--spacing)*51)}.m-70{margin:calc(var(--spacing)*70)}.m-76{margin:calc(var(--spacing)*76)}.m-77{margin:calc(var(--spacing)*77)}.m-88{margin:calc(var(--spacing)*88)}.m-94{margin:calc(var(--spacing)*94)}.m-138{margin:calc(var(--spacing)*138)}.m-148{margin:calc(var(--spacing)*148)}.m-155{margin:calc(var(--spacing)*155)}.m-195{margin:calc(var(--spacing)*195)}.m-260{margin:calc(var(--spacing)*260)}.m-307{margin:calc(var(--spacing)*307)}.m-1886{margin:calc(var(--spacing)*1886)}.m-2029{margin:calc(var(--spacing)*2029)}.m-2530{margin:calc(var(--spacing)*2530)}.m-2869{margin:calc(var(--spacing)*2869)}.mt-1{margin-top:calc(var(--spacing)*1)}.mt-8{margin-top:calc(var(--spacing)*8)}.mb-2{margin-bottom:calc(var(--spacing)*2)}.contents{display:contents}.flex{display:flex}.grid{display:grid}.inline-block{display:inline-block}.table{display:table}.h-4{height:calc(var(--spacing)*4)}.h-64{height:calc(var(--spacing)*64)}.min-h-screen{min-height:100vh}.w-4{width:calc(var(--spacing)*4)}.w-full{width:100%}.max-w-sm{max-width:var(--container-sm)}.flex-1{flex:1}.flex-grow{flex-grow:1}.transform{transform:var(--tw-rotate-x,)var(--tw-rotate-y,)var(--tw-rotate-z,)var(--tw-skew-x,)var(--tw-skew-y,)}.resize{resize:both}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-between{justify-content:space-between}.justify-end{justify-content:flex-end}.justify-items-center{justify-items:center}.gap-4{gap:calc(var(--spacing)*4)}.gap-8{gap:calc(var(--spacing)*8)}:where(.space-y-1>:not(:last-child)){--tw-space-y-reverse:0;margin-block-start:calc(calc(var(--spacing)*1)*var(--tw-space-y-reverse));margin-block-end:calc(calc(var(--spacing)*1)*calc(1 - var(--tw-space-y-reverse)))}.overflow-hidden{overflow:hidden}.rounded{border-radius:.25rem}.rounded-md{border-radius:var(--radius-md)}.border{border-style:var(--tw-border-style);border-width:1px}.border-t{border-top-style:var(--tw-border-style);border-top-width:1px}.border-b{border-bottom-style:var(--tw-border-style);border-bottom-width:1px}.border-gray-200{border-color:var(--color-gray-200)}.bg-gray-200{background-color:var(--color-gray-200)}.object-cover{object-fit:cover}.p-3{padding:calc(var(--spacing)*3)}.p-4{padding:calc(var(--spacing)*4)}.p-6{padding:calc(var(--spacing)*6)}.px-3{padding-inline:calc(var(--spacing)*3)}.py-1{padding-block:calc(var(--spacing)*1)}.py-4{padding-block:calc(var(--spacing)*4)}.py-6{padding-block:calc(var(--spacing)*6)}.pl-6{padding-left:calc(var(--spacing)*6)}.text-left{text-align:left}.text-right{text-align:right}.text-2xl{font-size:var(--text-2xl);line-height:var(--tw-leading,var(--text-2xl--line-height))}.text-lg{font-size:var(--text-lg);line-height:var(--tw-leading,var(--text-lg--line-height))}.leading-relaxed{--tw-leading:var(--leading-relaxed);line-height:var(--leading-relaxed)}.font-bold{--tw-font-weight:var(--font-weight-bold);font-weight:var(--font-weight-bold)}.font-medium{--tw-font-weight:var(--font-weight-medium);font-weight:var(--font-weight-medium)}.text-blue-600{color:var(--color-blue-600)}.text-gray-600{color:var(--color-gray-600)}.text-gray-700{color:var(--color-gray-700)}.text-white{color:var(--color-white)}.shadow-lg{--tw-shadow:0 10px 15px -3px var(--tw-shadow-color,#0000001a),0 4px 6px -4px var(--tw-shadow-color,#0000001a);box-shadow:var(--tw-inset-shadow),var(--tw-inset-ring-shadow),var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow)}.outline{outline-style:var(--tw-outline-style);outline-width:1px}.transition{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,--tw-gradient-from,--tw-gradient-via,--tw-gradient-to,opacity,box-shadow,transform,translate,scale,rotate,filter,-webkit-backdrop-filter,backdrop-filter;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-colors{transition-property:color,background-color,border-color,outline-color,text-decoration-color,fill,stroke,--tw-gradient-from,--tw-gradient-via,--tw-gradient-to;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-transform{transition-property:transform,translate,scale,rotate;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}@media (hover:hover){.hover\:border-blue-600:hover{border-color:var(--color-blue-600)}.hover\:bg-gray-200:hover{background-color:var(--color-gray-200)}}@media (min-width:48rem){.md\:w-xs{width:var(--container-xs)}.md\:grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.md\:flex-row{flex-direction:row}.md\:border-r-2{border-right-style:var(--tw-border-style);border-right-width:2px}.md\:border-b-0{border-bottom-style:var(--tw-border-style);border-bottom-width:0}}@media (min-width:64rem){.lg\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}}}:root{--accent:#2337ff;--accent-dark:#000d8a;--black:15,18,25;--gray:96,115,159;--gray-light:229,233,240;--gray-dark:34,41,57;--gray-gradient:rgba(var(--gray-light),50%),#fff;--green-50:#f0fdf4;--green-100:#dcfce7;--green-200:#bbf7d0;--blue-50:#eff6ff;--blue-100:#dbeafe;--blue-200:#bfdbfe;--box-shadow:0 2px 6px rgba(var(--gray),25%),0 8px 24px rgba(var(--gray),33%),0 16px 32px rgba(var(--gray),33%)}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff)format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff)format("woff");font-weight:700;font-style:normal;font-display:swap}body{text-align:left;background:linear-gradient(var(--gray-gradient))no-repeat;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--gray-dark));background-size:100% 600px;margin:0;padding:0;font-family:Atkinson,sans-serif;font-size:20px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{color:rgb(var(--black));margin:0 0 .5rem;line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}p:has(+ul),p:has(+pre),ul li p{margin-bottom:0}ol:has(+blockquote),ul:has(+blockquote),.prose ol:has(+p),.prose ul:has(+p){margin-bottom:1em}.prose p:has(+ol,ul){margin-bottom:0}.prose ol,ul{padding-left:1.5em;list-style-type:disc}.prose ul ul{padding-left:1.5em;list-style-type:circle}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%;margin-bottom:1em}table thead tr{background-color:rgba(var(--gray-light),50%)}table thead tr th{border-radius:3px;padding:.5rem}table tbody tr:not(:last-child){border-bottom:1px solid rgba(var(--gray-light),80%)}table tbody tr td{padding:.5rem}img{border-radius:8px;max-width:100%;height:auto;max-height:510px}code{background-color:var(--blue-50);border-radius:2px;padding:2px 5px}pre{border-radius:8px;padding:1.5em;white-space:pre!important}pre>code{all:unset;font-size:16px}blockquote{border-left:4px solid var(--accent);margin:0;padding:0 0 0 20px;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}svg[role="graphics-document document"]{justify-self:center;margin-bottom:1em}@media (max-width:720px){body{font-size:18px}main{padding:1em}p{text-align:justify}.line.diff.remove,.line.diff.add{padding:4px 8px 8px!important}.prose{max-width:100%!important;margin:0!important}}.line.diff.remove{background-color:#f7cccc1a;padding:7px 8px 8px;line-height:0}.line.diff.add{background-color:#00ff001a;padding:7px 8px 8px;line-height:0}.sr-only{clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap;border:0;width:1px;height:1px;margin:0;padding:0;overflow:hidden;position:absolute!important}@property --tw-rotate-x{syntax:"*";inherits:false}@property --tw-rotate-y{syntax:"*";inherits:false}@property --tw-rotate-z{syntax:"*";inherits:false}@property --tw-skew-x{syntax:"*";inherits:false}@property --tw-skew-y{syntax:"*";inherits:false}@property --tw-space-y-reverse{syntax:"*";inherits:false;initial-value:0}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-leading{syntax:"*";inherits:false}@property --tw-font-weight{syntax:"*";inherits:false}@property --tw-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-shadow-color{syntax:"*";inherits:false}@property --tw-shadow-alpha{syntax:"<percentage>";inherits:false;initial-value:100%}@property --tw-inset-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-inset-shadow-color{syntax:"*";inherits:false}@property --tw-inset-shadow-alpha{syntax:"<percentage>";inherits:false;initial-value:100%}@property --tw-ring-color{syntax:"*";inherits:false}@property --tw-ring-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-inset-ring-color{syntax:"*";inherits:false}@property --tw-inset-ring-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-ring-inset{syntax:"*";inherits:false}@property --tw-ring-offset-width{syntax:"<length>";inherits:false;initial-value:0}@property --tw-ring-offset-color{syntax:"*";inherits:false;initial-value:#fff}@property --tw-ring-offset-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-outline-style{syntax:"*";inherits:false;initial-value:solid}a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#fff;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex;justify-content:center;align-items:center}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}.navbar-logo[data-astro-cid-3ef6ksr2]{display:flex;justify-content:center;align-items:center}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}main[data-astro-cid-bvzihdzo]{width:calc(100% - 2em);max-width:100%;margin:0}.hero-image[data-astro-cid-bvzihdzo]{width:100%}.hero-image[data-astro-cid-bvzihdzo] img[data-astro-cid-bvzihdzo]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-bvzihdzo]{width:56rem;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-bvzihdzo]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-bvzihdzo] h1[data-astro-cid-bvzihdzo]{margin:0 0 .5em}.date[data-astro-cid-bvzihdzo]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-bvzihdzo]{font-style:italic}main[data-astro-cid-5tznm7mj]{width:960px}ul[data-astro-cid-5tznm7mj]{display:flex;flex-wrap:wrap;gap:2rem;list-style-type:none;margin:0;padding:0}ul[data-astro-cid-5tznm7mj] li[data-astro-cid-5tznm7mj]{width:calc(50% - 1rem)}ul[data-astro-cid-5tznm7mj] li[data-astro-cid-5tznm7mj] [data-astro-cid-5tznm7mj]{text-decoration:none;transition:.2s ease}ul[data-astro-cid-5tznm7mj] li[data-astro-cid-5tznm7mj]:first-child{width:100%;margin-bottom:1rem;text-align:center}ul[data-astro-cid-5tznm7mj] li[data-astro-cid-5tznm7mj]:first-child img[data-astro-cid-5tznm7mj]{width:100%}ul[data-astro-cid-5tznm7mj] li[data-astro-cid-5tznm7mj]:first-child .title[data-astro-cid-5tznm7mj]{font-size:2.369rem}ul[data-astro-cid-5tznm7mj] li[data-astro-cid-5tznm7mj] img[data-astro-cid-5tznm7mj]{margin-bottom:1.5rem;border-radius:12px}ul[data-astro-cid-5tznm7mj] li[data-astro-cid-5tznm7mj] a[data-astro-cid-5tznm7mj]{display:block}.title[data-astro-cid-5tznm7mj]{margin:0;color:rgb(var(--black));line-height:1.3}.date[data-astro-cid-5tznm7mj]{margin:0;color:rgb(var(--gray))}ul[data-astro-cid-5tznm7mj] li[data-astro-cid-5tznm7mj] a[data-astro-cid-5tznm7mj]:hover h4[data-astro-cid-5tznm7mj],ul[data-astro-cid-5tznm7mj] li[data-astro-cid-5tznm7mj] a[data-astro-cid-5tznm7mj]:hover .date[data-astro-cid-5tznm7mj]{color:rgb(var(--accent))}ul[data-astro-cid-5tznm7mj] a[data-astro-cid-5tznm7mj]:hover img[data-astro-cid-5tznm7mj]{box-shadow:var(--box-shadow)}ul[data-astro-cid-5tznm7mj] li[data-astro-cid-5tznm7mj]:not(:first-child) img[data-astro-cid-5tznm7mj]{height:240px}@media (max-width: 720px){ul[data-astro-cid-5tznm7mj]{gap:.5em}ul[data-astro-cid-5tznm7mj] li[data-astro-cid-5tznm7mj]{width:100%;text-align:center}ul[data-astro-cid-5tznm7mj] li[data-astro-cid-5tznm7mj]:first-child{margin-bottom:0}ul[data-astro-cid-5tznm7mj] li[data-astro-cid-5tznm7mj]:first-child .title[data-astro-cid-5tznm7mj]{font-size:1.563em}}main[data-astro-cid-2iqln3bm]{width:calc(100% - 2em);max-width:100%;margin:0}ul[data-astro-cid-2iqln3bm]{list-style-type:disc;padding-left:1.5em}ul[data-astro-cid-2iqln3bm] ul[data-astro-cid-2iqln3bm],ul[data-astro-cid-2iqln3bm] ul[data-astro-cid-2iqln3bm] ul[data-astro-cid-2iqln3bm]{list-style-type:circle}.hero-image[data-astro-cid-2iqln3bm]{width:100%}.hero-image[data-astro-cid-2iqln3bm] img[data-astro-cid-2iqln3bm]{display:block;margin:0 auto;border-radius:12px;box-shadow:var(--box-shadow)}.prose[data-astro-cid-2iqln3bm]{width:56rem;max-width:calc(100% - 2em);margin:auto;padding:1em;color:rgb(var(--gray-dark))}.title[data-astro-cid-2iqln3bm]{margin-bottom:1em;padding:1em 0;text-align:center;line-height:1}.title[data-astro-cid-2iqln3bm] h1[data-astro-cid-2iqln3bm]{margin:0 0 .5em}.date[data-astro-cid-2iqln3bm]{margin-bottom:.5em;color:rgb(var(--gray))}.last-updated-on[data-astro-cid-2iqln3bm]{font-style:italic}a[data-astro-cid-jwgesljd],a[data-astro-cid-jwgesljd]:hover{color:#4a5565}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <h2 class="navbar-logo" data-astro-cid-3ef6ksr2> <img width="40" height="40" src="/logo.png" alt="" data-astro-cid-3ef6ksr2> <a href="/" class="font-bold text-2xl" data-astro-cid-3ef6ksr2>BigJoe</a> </h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" class="active" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a>  <a href="/book" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Book </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://www.facebook.com/profile.php?id=61572916280350" target="_blank" data-astro-cid-3ef6ksr2> <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M13.458 21.696c4.693-.704 8.292-4.753 8.292-9.642c0-5.385-4.365-9.75-9.75-9.75s-9.75 4.365-9.75 9.75c0 4.89 3.599 8.938 8.292 9.642v-6.798h-2.05a.486.486 0 0 1-.486-.486v-1.843c0-.269.218-.486.486-.486h2.05l-.072-1.943c0-.942.175-2.471 1.342-3.307c.816-.583 1.423-.693 2.397-.693c.845 0 1.426.084 1.81.14l.188.025a.193.193 0 0 1 .168.192v2.04c0 .113-.095.2-.205.194h-.038c-.114.004-.71.029-1.216.029c-.89 0-1.458.406-1.458 1.755v1.568h2.192c.3 0 .529.27.48.566l-.28 1.843a.486.486 0 0 1-.479.406h-1.913z" data-astro-cid-3ef6ksr2></path> </svg> </a> <a href="https://x.com/joewalker_xyz" target="_blank" data-astro-cid-3ef6ksr2> <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" data-astro-cid-3ef6ksr2> <g fill="none" fill-rule="evenodd" data-astro-cid-3ef6ksr2> <path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z" data-astro-cid-3ef6ksr2></path> <path fill="currentColor" d="M19.753 4.659a1 1 0 0 0-1.506-1.317l-5.11 5.84L8.8 3.4A1 1 0 0 0 8 3H4a1 1 0 0 0-.8 1.6l6.437 8.582l-5.39 6.16a1 1 0 0 0 1.506 1.317l5.11-5.841L15.2 20.6a1 1 0 0 0 .8.4h4a1 1 0 0 0 .8-1.6l-6.437-8.582l5.39-6.16ZM16.5 19L6 5h1.5L18 19z" data-astro-cid-3ef6ksr2></path> </g> </svg> </a> <a href="https://github.com/joeteerawit" target="_blank" data-astro-cid-3ef6ksr2> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> </div> </nav> </header>  <main data-astro-cid-bvzihdzo> <article data-astro-cid-bvzihdzo> <div class="hero-image" data-astro-cid-bvzihdzo> <img width="1020" height="510" src="/2025/05/5dc29a33-7e5c-47f5-9066-f8eecea792fc.png" alt="" data-astro-cid-bvzihdzo> </div> <div class="prose" data-astro-cid-bvzihdzo> <div class="title" data-astro-cid-bvzihdzo> <div class="date" data-astro-cid-bvzihdzo> <time datetime="2025-05-03T00:00:00.000Z"> May 3, 2025 </time>  </div> <h1 data-astro-cid-bvzihdzo>Discord: Search หา message จากข้อมูลหลัก Trillion ยังไง?</h1> <hr data-astro-cid-bvzihdzo> </div>  <p>ย้อนกลับไปในปี 2017 Discord เริ่มเปิดตัว feature message search เป็นครั้งแรก เป็น feature ที่ user เรียกร้องกันมากในตอนนั้น ทีมของ Discord จึงเริ่มออกแบบระบบที่สามารถรองรับ search บน message ระดับ “trillions message” ได้ในช่วงเริ่มต้น</p>
<h2 id="การเลือกเทคโนโลยี">การเลือกเทคโนโลยี</h2>
<p>ทีม Discord เลือกใช้ Elasticsearch เพื่อเป็น backend ของระบบค้นหา ซึ่งเป็น open source ที่ทีมงานมีประสบการณ์ร่วมกันอยู่แล้ว Discordเคยพิจารณาโซลูชันแบบ managed SaaS มาก่อน แต่พบว่ามีค่าใช้จ่ายสูง และทีม Discord กังวลเกี่ยวกับการนำข้อมูล message ของ user ไปเก็บไว้กับ third-party</p>
<p>Elasticsearch เป็นระบบที่แบ่งข้อมูลออกเป็น index โดยในระบบของ Discord จะแยก index ตาม <code>guild</code> หรือ “DM” (direct message) ซึ่งทำให้สามารถค้นหาภายใน resource เดียวได้รวดเร็วโดยไม่ต้องกระจาย search ไปทั่ว cluster</p>
<p><img src="/2025/05/d1966df1-94c6-4e9e-9a2f-85c2823f5b9d.png" alt="d1966df1-94c6-4e9e-9a2f-85c2823f5b9d"></p>
<h2 id="lazy-indexing-เพื่อประหยัด-resources">Lazy Indexing เพื่อประหยัด Resources</h2>
<p>ทีม Discord เลือกใช้วิธีการ lazy indexing — หมายความว่า Discord จะไม่ index message ทั้งหมดทันที แต่จะทำ historical indexing เมื่อมี search เกิดขึ้นครั้งแรก และหลังจากนั้นจะ index message ใหม่แบบ real-time เฉพาะ guild หรือ DM ที่มี search เท่านั้น</p>
<p>เพื่อรองรับการ index แบบ real-time ทีม Discord ได้สร้าง message queue ที่ให้ worker ดึง message ออกมาเป็น batch แล้วทำการ index แบบ asynchronous ช่วยเพิ่มประสิทธิภาพในการใช้งาน Elasticsearch โดยใช้ bulk indexing API</p>
<h2 id="การออกแบบ-index-และ-shard">การออกแบบ Index และ Shard</h2>
<p>หนึ่งในการตัดสินใจที่สำคัญคือการจัดกลุ่ม message ตาม guild หรือ DM แต่ละอันจะถูกผูกกับ index เพียงหนึ่ง index และภายใน index นั้นจะมีเพียงหนึ่ง primary shard เท่านั้น ซึ่งช่วยให้ทีม Discord สามารถตอบ query ได้โดยไม่ต้อง fan-out ไปหลาย node ใน cluster</p>
<h3 id="โครงสร้างของ-elasticsearch">โครงสร้างของ Elasticsearch</h3>
<p><img src="/2025/05/59ecc872-ced1-4308-a1e2-350a68167a36.png" alt="59ecc872-ced1-4308-a1e2-350a68167a36"></p>
<p>Elasticsearch cluster ประกอบด้วยหลาย node แต่ละ node อาจทำหน้าที่แตกต่างกัน เช่น:</p>
<ul>
<li><strong>Master node</strong>: ทำหน้าที่ควบคุม coordination ของ cluster</li>
<li><strong>Ingest node</strong>: รับคำขอ query และ index แล้ว route ไปยัง data node</li>
<li><strong>Data node</strong>: เก็บข้อมูลจริงของ shard และตอบสนองต่อ search</li>
</ul>
<p>แต่ละ index จะมี shard ซึ่งเป็น Lucene inverted index โดย 1 shard จะอยู่บน node เดียวเท่านั้น และสามารถมี replica ได้</p>
<p>ในระบบของ Discord ทางทีมได้ออกแบบให้แต่ละ index มีเพียง 1 primary shard และ 1 replica ช่วยให้การจัดการง่ายขึ้น และทุก message query สามารถเข้าถึง shard ได้โดยตรงใน node เดียว ทำให้ latency ต่ำและ throughput สูง</p>
<h2 id="search-v2-การ-optimization-search-system-ของ-discord">Search V2: การ Optimization Search System ของ Discord</h2>
<h3 id="เปลี่ยนจาก-redis-ไปใช้-pubsub-เป็น-message-queue">เปลี่ยนจาก Redis ไปใช้ PubSub เป็น message queue</h3>
<p>จุดเริ่มต้นของการแก้ปัญหาคือการย้ายจาก Redis ไปใช้ PubSub ซึ่งมีความสามารถในการ <strong>รับประกันการส่ง message (guaranteed message delivery)</strong> และสามารถรองรับ backlog จำนวนมากได้โดยไม่ทำให้ message ถูก drop อีกต่อไป ถึงแม้การล่มของ Elasticsearch จะทำให้ indexing ช้าลง แต่จะไม่ทำให้ข้อมูลหายไปเหมือนเดิมอีกแล้ว</p>
<h3 id="ปรับวิธีการทำ-bulk-indexing-ให้-localized-มากขึ้น">ปรับวิธีการทำ bulk indexing ให้ localized มากขึ้น</h3>
<p><img src="/2025/05/93272d1c-a8f7-46ad-9235-f518442e8197.png" alt="93272d1c-a8f7-46ad-9235-f518442e8197"></p>
<p>ทีมยังใช้ bulk indexing อยู่ แต่ได้เปลี่ยนกลยุทธ์ใหม่โดยใช้ message router ที่เขียนด้วยภาษา Rust router นี้จะอ่าน message จาก PubSub แล้ว group message ตาม <code>destination</code> ซึ่งในบริบทนี้คือ Elasticsearch cluster และ index ที่ message นั้นจะถูกส่งไป</p>
<p>เมื่อ message router พบ destination ใหม่ มันจะ spawn unbounded channel และสร้าง tokio task หนึ่งตัวเพื่อรอรับ message ทั้งหมดที่มาจาก destination นั้น message ทั้งหมดใน channel เดียวกันนี้จะถูกจัด batch แล้วทำ bulk index ไปยัง node เดียวเท่านั้น ซึ่งหาก node ล้ม ก็จะกระทบแค่ batch เดียวนั้น ทำให้ระบบมีความทนทานต่อ failure มากขึ้นกว่าเดิมหลายเท่า</p>
<p>ในระบบเดิม batch ของ 50 message อาจกระจายไปยัง 50 nodes และล้มทั้ง batch หากมีเพียง 1 node ล้ม แต่ในระบบใหม่ message ถูกจัด batch ตาม destination ทำให้ปัญหานี้หายไปอย่างสิ้นเชิง</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="rust"><code><span class="line"><span style="color:#6A737D">/// MessageRouter routes messages to a set of dynamically spawned destinations.</span></span>
<span class="line"><span style="color:#6A737D">/// This is a simplified representation of the MessageRouter used to index</span></span>
<span class="line"><span style="color:#6A737D">/// new Discord messages into Elasticsearch.</span></span>
<span class="line"><span style="color:#D73A49">struct</span><span style="color:#6F42C1"> MessageRouter</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">DestinationKeyT</span><span style="color:#24292E">, </span><span style="color:#6F42C1">MessageT</span><span style="color:#24292E">> {</span></span>
<span class="line"><span style="color:#24292E">    destinations</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> RwLock</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">HashMap</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">DestinationKeyT</span><span style="color:#24292E">, </span><span style="color:#6F42C1">UnboundedSender</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">MessageT</span><span style="color:#24292E">>>,</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">impl</span><span style="color:#24292E">&#x3C;</span><span style="color:#6F42C1">DestinationKeyT</span><span style="color:#24292E">, </span><span style="color:#6F42C1">MessageT</span><span style="color:#24292E">> </span><span style="color:#6F42C1">MessageRouter</span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#6A737D">    /// Attempts to send the message to the given destination, spawning it</span></span>
<span class="line"><span style="color:#6A737D">    /// if the destination does not exist.</span></span>
<span class="line"><span style="color:#D73A49">    fn</span><span style="color:#6F42C1"> send_message</span><span style="color:#24292E">(</span></span>
<span class="line"><span style="color:#D73A49">        &#x26;</span><span style="color:#005CC5">self</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">        destination_key</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> DestinationKeyT</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">        message</span><span style="color:#D73A49">:</span><span style="color:#6F42C1"> MessageT</span><span style="color:#24292E">,</span></span>
<span class="line"><span style="color:#24292E">    ) </span><span style="color:#D73A49">-></span><span style="color:#6F42C1"> Result</span><span style="color:#24292E">&#x3C;()> {</span></span>
<span class="line"><span style="color:#D73A49">        let</span><span style="color:#D73A49"> mut</span><span style="color:#24292E"> destinations </span><span style="color:#D73A49">=</span><span style="color:#005CC5"> self</span><span style="color:#D73A49">.</span><span style="color:#24292E">destinations</span><span style="color:#D73A49">.</span><span style="color:#6F42C1">write</span><span style="color:#24292E">();</span></span>
<span class="line"><span style="color:#D73A49">        match</span><span style="color:#24292E"> destinations</span><span style="color:#D73A49">.</span><span style="color:#6F42C1">entry</span><span style="color:#24292E">(destination_key) {</span></span>
<span class="line"><span style="color:#6F42C1">            Entry</span><span style="color:#D73A49">::</span><span style="color:#6F42C1">Occupied</span><span style="color:#24292E">(</span><span style="color:#D73A49">mut</span><span style="color:#24292E"> ent) </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#6A737D">	              // Send the message to the given destination</span></span>
<span class="line"><span style="color:#24292E">	              ent</span><span style="color:#D73A49">.</span><span style="color:#6F42C1">get</span><span style="color:#24292E">()</span><span style="color:#D73A49">.</span><span style="color:#6F42C1">send</span><span style="color:#24292E">(message)</span><span style="color:#D73A49">.</span><span style="color:#6F42C1">ok</span><span style="color:#24292E">();</span></span>
<span class="line"><span style="color:#24292E">            }</span></span>
<span class="line"><span style="color:#6F42C1">            Entry</span><span style="color:#D73A49">::</span><span style="color:#6F42C1">Vacant</span><span style="color:#24292E">(ent) </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#6A737D">                // Spawn a new destination and receiver</span></span>
<span class="line"><span style="color:#D73A49">                let</span><span style="color:#24292E"> (destination_sender, destination_receiver) </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> unbounded_channel</span><span style="color:#24292E">();</span></span>
<span class="line"><span style="color:#D73A49">                let</span><span style="color:#24292E"> task </span><span style="color:#D73A49">=</span><span style="color:#6F42C1"> tokio</span><span style="color:#D73A49">::</span><span style="color:#6F42C1">task</span><span style="color:#D73A49">::</span><span style="color:#6F42C1">spawn</span><span style="color:#24292E">(</span><span style="color:#D73A49">async</span><span style="color:#D73A49"> move</span><span style="color:#24292E"> {</span></span>
<span class="line"><span style="color:#6A737D">                    // Destination task receives messages with same destination</span></span>
<span class="line"><span style="color:#6A737D">                    // key on destination_receiver.</span></span>
<span class="line"><span style="color:#6A737D">                    // For our case, the destination task groups messages into </span></span>
<span class="line"><span style="color:#6A737D">                    // chunks and bulk indexes into Elasticsearch.</span></span>
<span class="line"><span style="color:#24292E">                });</span></span>
<span class="line"><span style="color:#24292E">                ent</span><span style="color:#D73A49">.</span><span style="color:#6F42C1">insert</span><span style="color:#24292E">(destination_sender)</span><span style="color:#D73A49">.</span><span style="color:#6F42C1">send</span><span style="color:#24292E">(message)</span><span style="color:#D73A49">.</span><span style="color:#6F42C1">ok</span><span style="color:#24292E">();</span></span>
<span class="line"><span style="color:#24292E">            }</span></span>
<span class="line"><span style="color:#24292E">        }</span></span>
<span class="line"><span style="color:#6F42C1">        Ok</span><span style="color:#24292E">(())</span></span>
<span class="line"><span style="color:#24292E">    }</span></span>
<span class="line"><span style="color:#24292E">}</span></span></code></pre>
<h3 id="ย้ายระบบขึ้น-kubernetes-พร้อม-elastic-cloud-on-kubernetes-eck">ย้ายระบบขึ้น Kubernetes พร้อม Elastic Cloud on Kubernetes (ECK)</h3>
<p><img src="/2025/05/3e8bf59d-3b08-4d97-aac7-37df129be0c1.png" alt="3e8bf59d-3b08-4d97-aac7-37df129be0c1"></p>
<p>อีกหนึ่งการตัดสินใจเชิง Architecture ที่พลิกเกม คือการย้ายระบบ search ทั้งหมดขึ้นไปอยู่บน Kubernetes โดยใช้ Elastic Cloud on Kubernetes (ECK) ซึ่งเป็น operator สำหรับ orchestrating Elasticsearch บน Kubernetes</p>
<p>ECK ช่วยให้ Discord กำหนด topology ของ cluster ได้ชัดเจน เช่น จำนวน master nodes, ingest nodes, และ data nodes แต่ละประเภทสามารถกำหนด resource ตาม workload ได้ และยังทำ rolling upgrade ได้อย่างปลอดภัยแบบไม่มี downtime ซึ่งเป็นสิ่งที่ระบบเดิมไม่สามารถทำได้เลย</p>
<p>OS upgrades สามารถทำผ่าน rolling restart ของ node pool โดยไม่ต้อง stop ทั้ง system</p>
<h2 id="multi-cluster-cell-architecture-แนวคิดใหม่เพื่อ-scale-และ-isolate">Multi-cluster Cell Architecture: แนวคิดใหม่เพื่อ scale และ isolate</h2>
<p><img src="/2025/05/d32266b4-7590-4113-8df4-0ea01fa607a3.png" alt="d32266b4-7590-4113-8df4-0ea01fa607a3"></p>
<p>เพื่อหลีกเลี่ยงปัญหาที่เคยเกิดกับ cluster ใหญ่ที่รวมทุกอย่างไว้ที่เดียว ทีม Discord จึงแยกออกเป็น <strong>cell architecture</strong> ซึ่งในที่นี้ cell คือกลุ่มของ Elasticsearch clusters หลายชุด โดยแต่ละชุดมีหน้าที่จัดการกับข้อมูลเฉพาะด้าน เช่น:</p>
<ul>
<li>cell หนึ่งสำหรับจัดการ message จาก guild</li>
<li>cell หนึ่งสำหรับ DM messages ซึ่ง shard ตาม user แทน channel</li>
</ul>
<p>แนวคิดนี้ทำให้ทีมสามารถ index และ search message ในมิติใหม่ เช่น cross-DM search หรือ search ข้าม direct message ทั้งหมดที่ user เคยมี ซึ่งไม่สามารถทำได้ในระบบเดิมที่ shard ตาม channel</p>
<p>cell แต่ละชุดประกอบด้วย ingest nodes, master-eligible nodes และ data nodes ซึ่งแยกกันอย่างชัดเจนเพื่อป้องกันการเกิด bottleneck และลด coordination overhead โดยสามารถเลือกขนาดของ cluster แต่ละชุดให้เหมาะกับ workload ของตนได้</p>
<p>ตัวอย่างเช่น guild ปกติอาจใช้ cluster เล็กๆ ที่มี 1 primary shard ต่อ index แต่สำหรับ Big Freaking Guilds (BFGs) ที่มี message หลาย trillions message จะใช้ index ที่มี multiple primary shards เพื่อรองรับการ fan-out query แบบขนานได้</p>
<h2 id="การจัดการ-big-freaking-guilds-bfgs">การจัดการ Big Freaking Guilds (BFGs)</h2>
<p><img src="/2025/05/0e1087f5-e5a9-4704-882a-efd5f17819a8.png" alt="0e1087f5-e5a9-4704-882a-efd5f17819a8"></p>
<p>ในระบบ Search V1 ทีม Discord ออกแบบให้ guild หนึ่งถูกผูกกับ index เดียว ซึ่งภายใน index นั้นจะมี 1 primary shard และ 1 replica แนวทางนี้มีข้อดีคือ query ใด ๆ ภายใน guild นั้นสามารถเข้าถึงได้ใน node เดียว โดยไม่ต้อง fan-out หรือประสานข้อมูลข้าม shard ซึ่งช่วยให้ latency ต่ำมาก</p>
<p>แต่สำหรับ guild ที่มี message เกิน 2 trillions Lucene จะไม่สามารถ index เพิ่มเติมได้อีกเลย การแก้ปัญหาชั่วคราวใน Search V1 คือให้ทีม Safety ตรวจสอบและลบ guild ที่เป็น spam เพื่อให้ space ที่ว่างกลับมา แต่แน่นอนว่าทีม Discord ไม่สามารถใช้วิธีนี้ในระยะยาวกับชุมชน user งานจริงที่มี message ปริมาณมหาศาลได้</p>
<p>ใน Search V2 ทีมได้สร้างกลไกการ reindex สำหรับ BFGs ที่สามารถ <strong>ย้ายข้อมูลจาก index เก่าไปยัง index ใหม่ที่มีหลาย primary shards</strong> ได้โดยไม่ต้อง stop service หรือ stop indexing message ใหม่</p>
<p>ขั้นตอนการ reindex มีดังนี้:</p>
<ol>
<li>ตรวจจับว่า guild ใดใกล้จะชน <code>MAX_DOC</code> limit ซึ่งปกติถูกเก็บอยู่ใน <code>index-a</code></li>
<li>สร้าง <code>new-bfg-index</code> ที่มีจำนวน primary shard มากกว่าเดิม 2 เท่า</li>
<li>เริ่มทำ <strong>dual-indexing</strong> โดย message ใหม่จะถูก index ทั้งใน <code>index-a</code> และ <code>new-bfg-index</code></li>
<li>เริ่ม job สำหรับ historical reindex โดยค่อย ๆ นำ message เก่าจาก guild นี้ไปใส่ใน <code>new-bfg-index</code></li>
<li>ขณะ historical index ดำเนินอยู่ ระบบยังคงตอบ query จาก <code>index-a</code> ตามปกติ</li>
<li>เมื่อ historical index เสร็จสมบูรณ์ และมั่นใจว่า <code>new-bfg-index</code> ทำงานได้ดี จะสามารถเปลี่ยน traffic query ไปยัง index ใหม่</li>
<li>จากนั้นจะหยุด dual-indexing แล้วลบ message ทั้งหมดออกจาก <code>index-a</code></li>
</ol>
<p>ด้วยวิธีนี้ BFGs จะสามารถใช้ index ใหม่ที่มีหลาย shards ซึ่งช่วยให้ search query สามารถ parallelize ได้ และเพิ่ม throughput ได้มากกว่าระบบเดิมที่ใช้ shard เดียว</p>
<h2 id="ผลลัพธ์ของ-search-v2-เปลี่ยนเกมอย่างแท้จริง">ผลลัพธ์ของ Search V2: เปลี่ยนเกมอย่างแท้จริง</h2>
<p>หลังจากเปิดใช้งานระบบ Search V2 เต็มรูปแบบ Discord สามารถ index message ระดับ <code>trillions message</code> ได้จริง และที่สำคัญคือ throughput เพิ่มขึ้น <strong>มากกว่าสองเท่า</strong> จากระบบเดิม</p>
<p>latency โดยรวมดีขึ้นชัดเจน: จาก median latency 500ms ใน Search V1 เหลือเพียง <strong>น้อยกว่า 100ms</strong> ใน Search V2 ส่วน P95 และ P99 ลดลงจากประมาณ 1 วินาที เหลือเพียง <strong>ไม่ถึง 500ms</strong></p>
<p>Discord สามารถทำ rolling upgrade ได้แบบไม่มี downtime ทำให้ระบบสามารถรับ patch ใหม่ ๆ ได้ทันเวลา เช่นกรณี log4shell ที่เคยทำให้ Search V1 ต้องหยุดระบบทั้งระบบเพื่อ patch log4j แต่ใน Search V2 ทำได้ทันทีโดยไม่กระทบ user เลยแม้แต่น้อย</p>
<p>ทุกวันนี้ Discord ใช้ Elasticsearch clusters กว่า 40 clusters กระจายออกเป็น <code>cells</code> หลายชุด และภายในมี indices นับพัน เพื่อรองรับ message ทั้งจาก guild, DM, BFG และ use case ใหม่ ๆ อย่าง cross-DM search</p>
<p>จาก search system ที่เคยเปราะบางและยากต่อการ scale, Discord ได้สร้าง Search V2 ที่สามารถ scale ได้ในระดับ global พร้อมความเร็ว ความทนทาน และความสามารถในการดูแลรักษาได้อย่างมืออาชีพ</p>
<p>หากคุณเป็น engineer ที่กำลังออกแบบระบบค้นหาของตัวเอง หวังว่าบทเรียนจาก Discord เรื่องนี้จะช่วยให้คุณเข้าใจว่าการออกแบบ search infrastructure ที่ดีนั้นไม่ได้ขึ้นอยู่กับการเลือกเทคโนโลยีเพียงอย่างเดียว แต่อยู่ที่การเข้าใจ workload, การ shard ข้อมูลอย่างถูกต้อง, และการรองรับ failure อย่างเป็นระบบ</p>
<h4 id="references">References:</h4>
<ul>
<li><a href="https://www.youtube.com/watch?v=k8PCBbt9j-o">youtube.com</a></li>
<li><a href="https://discord.com/blog/how-discord-indexes-trillions-of-messages">discord.com</a></li>
</ul>  </div> </article> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2025 BigJoe. All rights reserved.
<div class="social-links" data-astro-cid-sz7xmlte> <a href="https://www.facebook.com/profile.php?id=61572916280350" target="_blank" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" data-astro-cid-sz7xmlte> <path fill="currentColor" d="M13.458 21.696c4.693-.704 8.292-4.753 8.292-9.642c0-5.385-4.365-9.75-9.75-9.75s-9.75 4.365-9.75 9.75c0 4.89 3.599 8.938 8.292 9.642v-6.798h-2.05a.486.486 0 0 1-.486-.486v-1.843c0-.269.218-.486.486-.486h2.05l-.072-1.943c0-.942.175-2.471 1.342-3.307c.816-.583 1.423-.693 2.397-.693c.845 0 1.426.084 1.81.14l.188.025a.193.193 0 0 1 .168.192v2.04c0 .113-.095.2-.205.194h-.038c-.114.004-.71.029-1.216.029c-.89 0-1.458.406-1.458 1.755v1.568h2.192c.3 0 .529.27.48.566l-.28 1.843a.486.486 0 0 1-.479.406h-1.913z" data-astro-cid-sz7xmlte></path> </svg> </a> <a href="https://x.com/joewalker_xyz" target="_blank" data-astro-cid-sz7xmlte> <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" data-astro-cid-sz7xmlte> <g fill="none" fill-rule="evenodd" data-astro-cid-sz7xmlte> <path d="m12.594 23.258l-.012.002l-.071.035l-.02.004l-.014-.004l-.071-.036q-.016-.004-.024.006l-.004.01l-.017.428l.005.02l.01.013l.104.074l.015.004l.012-.004l.104-.074l.012-.016l.004-.017l-.017-.427q-.004-.016-.016-.018m.264-.113l-.014.002l-.184.093l-.01.01l-.003.011l.018.43l.005.012l.008.008l.201.092q.019.005.029-.008l.004-.014l-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014l-.034.614q.001.018.017.024l.015-.002l.201-.093l.01-.008l.003-.011l.018-.43l-.003-.012l-.01-.01z" data-astro-cid-sz7xmlte></path> <path fill="currentColor" d="M19.753 4.659a1 1 0 0 0-1.506-1.317l-5.11 5.84L8.8 3.4A1 1 0 0 0 8 3H4a1 1 0 0 0-.8 1.6l6.437 8.582l-5.39 6.16a1 1 0 0 0 1.506 1.317l5.11-5.841L15.2 20.6a1 1 0 0 0 .8.4h4a1 1 0 0 0 .8-1.6l-6.437-8.582l5.39-6.16ZM16.5 19L6 5h1.5L18 19z" data-astro-cid-sz7xmlte></path> </g> </svg> </a> <a href="https://github.com/joeteerawit" target="_blank" data-astro-cid-sz7xmlte> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-sz7xmlte><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-sz7xmlte></path></svg> </a> </div> </footer>  <script type="module">const l=window.innerWidth<=720;document.addEventListener("DOMContentLoaded",()=>{const r=t=>{let e=t.parentElement;for(;e;){if(e.tagName==="NAV")return!0;e=e.parentElement}return!1};document.querySelectorAll(".prose p").forEach(t=>{r(t)||t.querySelector("img")&&(t.style.justifyItems="center")}),document.querySelectorAll("h1, h2, h3, h4, h5, h6").forEach(t=>{const e=t;if(r(t))return;const o=t.nextElementSibling,n=o&&o.tagName.toLowerCase()==="pre";l?(e.style.marginTop="1rem",e.style.marginBottom=n?"0":"1rem"):(e.style.marginTop="2rem",e.style.marginBottom=n?"0":"2rem")}),document.querySelectorAll(".diff.remove").forEach(t=>{if(r(t))return;const e=document.createElement("span");e.className="diff-indicator",e.textContent="-",e.style.display="inline-block",e.style.width="15px",e.style.color="#d73a49",e.style.fontWeight="bold",e.style.userSelect="none",t.insertBefore(e,t.firstChild)}),document.querySelectorAll(".diff.add").forEach(t=>{if(r(t))return;const e=document.createElement("span");e.className="diff-indicator",e.textContent="+",e.style.display="inline-block",e.style.width="15px",e.style.color="#22863a",e.style.fontWeight="bold",e.style.userSelect="none",t.insertBefore(e,t.firstChild)}),document.querySelectorAll('a[href^="http"]').forEach(t=>{r(t)||(t.setAttribute("target","_blank"),t.setAttribute("rel","noopener noreferrer"))})});</script> </body></html>